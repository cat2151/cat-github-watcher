# cat-github-watcher

**PR monitoring tool for the automated implementation phase by GitHub Copilot**

<p align="left">
  <a href="README.ja.md"><img src="https://img.shields.io/badge/üáØüáµ-Japanese-red.svg" alt="Japanese"></a>
  <a href="README.md"><img src="https://img.shields.io/badge/üá∫üá∏-English-blue.svg" alt="English"></a>
</p>

*Note: This document is largely AI-generated. It was generated by submitting an issue to an agent.*

## Status
- Currently dogfooding.
- Major bugs have been addressed.
- Frequent breaking changes are expected.
- Memo
  - Initially, implementation was attempted with GitHub Actions, but it was found unsuitable for PR monitoring, so we transitioned to a Python version.
  - The Python version monitors user-owned repositories of authenticated GitHub users and performs notifications and actions based on the PR phase.

## Quick Links
| Item | Link |
|------|--------|
| üìä GitHub Repository | [cat2151/cat-github-watcher](https://github.com/cat2151/cat-github-watcher) |

## Overview

This is a Python tool that monitors the phases of Pull Requests where GitHub Copilot performs automated implementation and executes appropriate notifications and actions at the right time.
It efficiently monitors PRs in user-owned repositories of authenticated GitHub users, leveraging the GraphQL API.

## Features

- **Automated All-Repository Monitoring**: Automatically monitors PRs in user-owned repositories of authenticated GitHub users.
- **GraphQL API Utilization**: Achieves fast monitoring through efficient data retrieval.
- **Phase Detection**: Automatically determines PR status (phase1: Draft state, phase2: Addressing review comments, phase3: Awaiting review, LLM working: Coding agent in progress).
- **Dry-run Mode**: By default, only monitoring is performed, and actual actions (commenting, making PR ready, sending notifications) are not executed. Safe operation is possible by explicitly enabling it.
- **Automated Comment Posting**: Automatically posts appropriate comments based on the phase (Requires enabling in config file).
- **Automated Draft PR Ready-fication**: Automatically changes Draft PRs to a Ready state for addressing review comments in phase2 (Requires enabling in config file).
- **Mobile Notifications**: Uses ntfy.sh to send notifications to mobile devices when phase3 (awaiting review) is detected (Requires enabling in config file).
- **Issue List Display**: If all PRs are "LLM working", displays the top 10 issues from repositories with no open PRs.

## Architecture

This tool is a Python application modularized according to the Single Responsibility Principle (SRP).

### Directory Structure

```
cat-github-watcher/
‚îú‚îÄ‚îÄ cat-github-watcher.py    # Entry point
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îî‚îÄ‚îÄ gh_pr_phase_monitor/
‚îÇ       ‚îú‚îÄ‚îÄ colors.py         # ANSI color codes and coloring
‚îÇ       ‚îú‚îÄ‚îÄ config.py         # Configuration loading and parsing
‚îÇ       ‚îú‚îÄ‚îÄ github_client.py  # GitHub API integration
‚îÇ       ‚îú‚îÄ‚îÄ phase_detector.py # PR phase detection logic
‚îÇ       ‚îú‚îÄ‚îÄ comment_manager.py # Comment posting and verification
‚îÇ       ‚îú‚îÄ‚îÄ pr_actions.py     # PR actions (Ready-fication, browser launch)
‚îÇ       ‚îî‚îÄ‚îÄ main.py           # Main execution loop
‚îî‚îÄ‚îÄ tests/                    # Test files
```

### Phase Detection Logic

The tool identifies the following four phases:

1.  **phase1 (Draft State)**: When a PR is in Draft state and has review requests.
2.  **phase2 (Addressing Review Comments)**: When `copilot-pull-request-reviewer` has posted review comments, and corrections are needed.
3.  **phase3 (Awaiting Review)**: When `copilot-swe-agent` has completed corrections and is awaiting human review.
4.  **LLM working (Coding Agent in Progress)**: If none of the above apply (e.g., Copilot is implementing).

## Usage

### Prerequisites

- Python 3.x is installed.
- GitHub CLI (`gh`) is installed and authenticated.
  ```bash
  gh auth login
  ```

### Setup

1.  Clone this repository:
    ```bash
    git clone https://github.com/cat2151/cat-github-watcher.git
    cd cat-github-watcher
    ```

2.  Create a configuration file (optional):
    ```bash
    cp config.toml.example config.toml
    ```

3.  Edit `config.toml` to configure monitoring interval, execution mode, ntfy.sh notifications, Copilot auto-assignment, and auto-merge (optional):
    ```toml
    # Check interval (e.g., "30s", "1m", "5m", "1h", "1d")
    interval = "1m"
    
    # Execution control flags - only configurable within [[rulesets]] sections
    # Global flags are no longer supported
    # To apply settings to all repositories, use 'repositories = ["all"]'
    
    # Ruleset configuration example:
    # [[rulesets]]
    # name = "Default for all repositories - dry-run mode"
    # repositories = ["all"]  # "all" matches all repositories
    # enable_execution_phase1_to_phase2 = false  # Set to true to make draft PRs ready
    # enable_execution_phase2_to_phase3 = false  # Set to true to post phase2 comments
    # enable_execution_phase3_send_ntfy = false  # Set to true to send ntfy notifications
    # enable_execution_phase3_to_merge = false   # Set to true to merge phase3 PRs
    
    # ntfy.sh notification settings (optional)
    # Notifications include a clickable action button to open the PR
    [ntfy]
    enabled = false  # Set to true to enable notifications
    topic = "<Your ntfy.sh topic name here>"  # Use an unguessable string, as anyone can read/write to it.
    message = "PR is ready for review: {url}"  # Message template
    priority = 4  # Notification priority (1=lowest, 3=default, 4=high, 5=highest)
    
    # Phase3 Auto-merge settings (optional)
    # Automatically merges the PR when it reaches phase3 (awaiting review).
    # Before merging, the comment defined below will be posted to the PR.
    # After a successful merge, the feature branch will be automatically deleted.
    [phase3_merge]
    enabled = false  # Set to true to enable auto-merge (also requires enable_execution_phase3_to_merge = true in rulesets)
    comment = "All checks passed. Merging PR."  # Comment to post before merging
    automated = false  # Set to true to click merge button via browser automation
    automation_backend = "selenium"  # Automation backend: "selenium" or "playwright"
    wait_seconds = 10  # Wait time in seconds after browser launch before clicking button
    browser = "edge"  # Browser to use: Selenium: "edge", "chrome", "firefox" / Playwright: "chromium", "firefox", "webkit"
    headless = false  # Run in headless mode (without displaying a window)
    
    # Auto-assign "good first issue" issues to Copilot (optional)
    # If enabled, it will open the issue in the browser and prompt you to click the "Assign to Copilot" button.
    # If automated = true, it will automatically click the button via browser automation (Selenium required).
    [assign_to_copilot]
    enabled = false  # Set to true to enable auto-assignment feature
    automated = false  # Set to true to enable browser automation (Requires: pip install selenium webdriver-manager)
    wait_seconds = 10  # Wait time in seconds after browser launch before clicking button
    browser = "edge"  # Browser to use ("edge", "chrome", "firefox")
    ```

4.  (Optional) If using browser automation, install Selenium:
    ```bash
    pip install -r requirements-automation.txt
    ```
    or
    ```bash
    pip install selenium webdriver-manager
    ```
    
    Additionally, you will need the driver for your chosen browser:
    - **Edge**: Standard on Windows 10/11 (no additional installation needed)
    - **Chrome**: ChromeDriver will be downloaded automatically.
    - **Firefox**: GeckoDriver will be downloaded automatically.
    ```

### Running

Start the tool to begin monitoring:

```bash
python3 cat-github-watcher.py [config.toml]
```

Or, run directly as a Python module:

```bash
python3 -m src.gh_pr_phase_monitor.main [config.toml]
```

### Workflow

1.  **Startup**: When the tool is started, it begins monitoring user-owned repositories of authenticated GitHub users.
2.  **PR Detection**: Automatically detects repositories with open PRs.
3.  **Phase Determination**: Determines the phase of each PR (phase1/2/3, LLM working).
4.  **Action Execution**:
    -   **phase1**: Dry-run by default (Changes Draft PR to Ready state with `enable_execution_phase1_to_phase2 = true`).
    -   **phase2**: Dry-run by default (Posts a comment requesting Copilot to apply changes with `enable_execution_phase2_to_phase3 = true`).
    -   **phase3**: Opens the PR page in the browser (Also sends ntfy.sh notification with `enable_execution_phase3_send_ntfy = true`, automatically merges PR with `enable_execution_phase3_to_merge = true`).
    -   **LLM working**: Waits (If all PRs are in this state, displays issues from repositories with no open PRs).
5.  **Repetition**: Continues monitoring at the configured interval.

### Dry-run Mode

By default, the tool operates in **Dry-run mode** and does not execute actual actions, allowing for safe verification of its operation.

-   **Phase1 (Draft ‚Üí Ready)**: Displays `[DRY-RUN] Would mark PR as ready for review` but does nothing actually.
-   **Phase2 (Comment Posting)**: Displays `[DRY-RUN] Would post comment for phase2` but does nothing actually.
-   **Phase3 (ntfy Notification)**: Displays `[DRY-RUN] Would send ntfy notification` but does nothing actually.
-   **Phase3 (Merge)**: Displays `[DRY-RUN] Would merge PR` but does nothing actually.

To enable actual actions, set the following flags to `true` in `config.toml`:
```toml
enable_execution_phase1_to_phase2 = true  # Make Draft PR ready
enable_execution_phase2_to_phase3 = true  # Post Phase2 comment
enable_execution_phase3_send_ntfy = true  # Send ntfy notification
enable_execution_phase3_to_merge = true   # Merge Phase3 PR
```

### Stopping

You can stop monitoring with `Ctrl+C`.

## Important Notes

-   GitHub CLI (`gh`) must be installed and authenticated.
-   This tool assumes integration with GitHub Copilot (specifically `copilot-pull-request-reviewer` and `copilot-swe-agent`).
-   Only **user-owned repositories** of authenticated users are monitored. Organization repositories are not included to keep the tool simple and focused (YAGNI principle).
-   Be mindful of API rate limits when using the GraphQL API.
-   If using ntfy.sh notifications, please configure a topic on [ntfy.sh](https://ntfy.sh/) beforehand.

## Testing

The project includes a test suite using pytest:

```bash
pytest tests/
```

## License

MIT License - See the LICENSE file for details.

*Note: The English README.md is automatically generated by GitHub Actions using Gemini's translation based on README.ja.md.*

*Big Brother is watching your repositories. Now it‚Äôs the cat.* üê±