# cat-github-watcher

**PR Monitoring Tool for GitHub Copilot's Automated Implementation Phase**

<p align="left">
  <a href="README.ja.md"><img src="https://img.shields.io/badge/üáØüáµ-Japanese-red.svg" alt="Japanese"></a>
  <a href="README.md"><img src="https://img.shields.io/badge/üá∫üá∏-English-blue.svg" alt="English"></a>
  <a href="https://deepwiki.com/cat2151/cat-github-watcher"><img src="https://deepwiki.com/badge.svg" alt="Ask DeepWiki"></a>
</p>

Note: A significant portion of this document is AI-generated. It was generated by submitting an issue to an agent.

## Status
- Currently dogfooding.
- Most major bugs have been fixed.
- Breaking changes are frequent.
- Notes
  - Initially, we attempted to implement this using GitHub Actions, but it proved unsuitable for PR monitoring, so we transitioned to a Python version.
  - The Python version monitors user-owned repositories for authenticated GitHub users and performs notifications and actions based on the PR phase.

## Quick Links
| Item | Link |
|------|--------|
| üìä GitHub Repository | [cat2151/cat-github-watcher](https://github.com/cat2151/cat-github-watcher) |

## Overview

This Python tool monitors the phases of GitHub Copilot's automated implementation PRs and performs appropriate notifications and actions at the right time. It efficiently monitors PRs using the GraphQL API for user-owned repositories of authenticated GitHub users.

## Features

- **Automatic monitoring of all repositories**: Automatically monitors PRs in user-owned repositories of authenticated GitHub users.
- **GraphQL API utilization**: Achieves high-speed monitoring through efficient data acquisition.
- **Phase detection**: Automatically determines the PR state (phase1: Draft, phase2: Addressing review comments, phase3: Awaiting review, LLM working: Coding agent at work).
- **Dry-run mode**: By default, only monitors and does not execute actual actions (posting comments, marking PRs as Ready, sending notifications). Can be safely operated by explicit activation.
- **Automatic comment posting**: Automatically posts appropriate comments depending on the phase (requires activation in the configuration file).
- **Automatic Draft PR Ready-ing**: Automatically changes Draft PRs to a Ready state for addressing review comments in phase2 (requires activation in the configuration file).
- **Mobile notifications**: Uses ntfy.sh to send notifications to mobile devices when phase3 (awaiting review) is detected (requires activation in the configuration file).
  - Notifies when an individual PR enters phase3.
  - Also notifies when all PRs are in phase3 (message configurable in `toml`).
- **Issue list display**: If all PRs are "LLM working", displays the top N issues for repositories without open PRs (default: 10, configurable with `issue_display_limit`).
- **Power-saving mode**: Automatically extends the monitoring interval to reduce API usage when no status changes occur (`no_change_timeout` and `reduced_frequency_interval` are configurable).
- **Verbose mode**: Displays detailed configuration information on startup and during execution to help detect misconfigurations (enabled with `verbose`).

## Architecture

This tool is a modularized Python application following the Single Responsibility Principle (SRP).

### Directory Structure

```
cat-github-watcher/
‚îú‚îÄ‚îÄ cat-github-watcher.py    # Entry point
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îî‚îÄ‚îÄ gh_pr_phase_monitor/
‚îÇ       ‚îú‚îÄ‚îÄ colors.py         # ANSI color codes and coloring
‚îÇ       ‚îú‚îÄ‚îÄ config.py         # Configuration loading and parsing
‚îÇ       ‚îú‚îÄ‚îÄ github_client.py  # GitHub API integration
‚îÇ       ‚îú‚îÄ‚îÄ phase_detector.py # PR phase detection logic
‚îÇ       ‚îú‚îÄ‚îÄ comment_manager.py # Comment posting and verification
‚îÇ       ‚îú‚îÄ‚îÄ pr_actions.py     # PR actions (Ready-ing, browser launch)
‚îÇ       ‚îî‚îÄ‚îÄ main.py           # Main execution loop
‚îî‚îÄ‚îÄ tests/                    # Test files
```

### Phase Detection Logic

The tool detects the following four phases:

1.  **phase1 (Draft State)**: When the PR is in a Draft state and has review requests.
2.  **phase2 (Addressing Review Comments)**: When `copilot-pull-request-reviewer` posts review comments and changes are required.
3.  **phase3 (Awaiting Review)**: When `copilot-swe-agent` completes fixes and is awaiting human review.
4.  **LLM working (Coding Agent at Work)**: If none of the above apply (e.g., Copilot is implementing).

## Usage

### Prerequisites

-   Python 3.10 or higher is installed.
-   GitHub CLI (`gh`) is installed and authenticated.
    ```bash
    gh auth login
    ```

### Setup

1.  Clone this repository:
    ```bash
    git clone https://github.com/cat2151/cat-github-watcher.git
    cd cat-github-watcher
    ```

2.  Create a configuration file (optional):
    ```bash
    cp config.toml.example config.toml
    ```

3.  Edit `config.toml` to configure monitoring interval, execution mode, ntfy.sh notifications, Copilot auto-assignment, and auto-merge (optional):
    ```toml
    # Check interval (e.g., "30s", "1m", "5m", "1h", "1d")
    interval = "1m"
    
    # Maximum number of issues to display from repositories with no open PRs
    # Default is 10, but can be changed to any positive number (e.g., 5, 15, 20)
    issue_display_limit = 10
    
    # Timeout duration for no state change
    # If the state of all PRs (phase of each PR) does not change for this duration,
    # the monitoring interval will switch to power-saving mode (reduced_frequency_interval below).
    # Set to an empty string "" to disable.
    # Supported formats: "30s", "1m", "5m", "30m", "1h", "1d"
    # Default: "30m" (30 minutes - stability priority)
    no_change_timeout = "30m"
    
    # Override the coding agent mention used in posted comments (defaults to @copilot)
    [coding_agent]
    agent_name = "@codex[agent]"
    
    # Monitoring interval in power-saving mode
    # If no state changes are detected within the no_change_timeout period,
    # the monitoring interval switches to this interval to reduce API usage.
    # It reverts to the normal monitoring interval when changes are detected.
    # Supported formats: "30s", "1m", "5m", "30m", "1h", "1d"
    # Default: "1h" (1 hour)
    reduced_frequency_interval = "1h"
    
    # Verbose mode - displays detailed configuration information
    # If enabled, it displays all settings on startup and repository-specific settings during execution.
    # This helps detect misconfigurations.
    # Default: false
    verbose = false
    
    # Execution control flags - only configurable within [[rulesets]] sections
    # Global flags are no longer supported.
    # To apply settings to all repositories, use 'repositories = ["all"]'.
    
    # Example ruleset configuration:
    # [[rulesets]]
    # name = "Default for all repositories - dry-run mode"
    # repositories = ["all"]  # "all" matches all repositories
    # enable_execution_phase1_to_phase2 = false  # Set to true to mark draft PRs as ready
    # enable_execution_phase2_to_phase3 = false  # Set to true to post phase2 comments
    # enable_execution_phase3_send_ntfy = false  # Set to true to send ntfy notifications
    # enable_execution_phase3_to_merge = false   # Set to true to merge phase3 PRs
    
    # [[rulesets]]
    # name = "Simple: Auto-assign good first issue to Copilot"
    # repositories = ["my-repo"]
    # assign_good_first_old = true  # This is enough! The [assign_to_copilot] section is not needed.
    #                               # Default behavior: Opens issue in browser for manual assignment
    
    # ntfy.sh notification settings (optional)
    # Notifications include clickable action buttons to open the PR.
    [ntfy]
    enabled = false  # Set to true to enable notifications
    topic = "<enter your ntfy.sh topic name here>"  # It's publicly readable/writable, so use an unguessable string.
    message = "PR is ready for review: {url}"  # Message template
    priority = 4  # Notification priority (1=lowest, 3=default, 4=high, 5=highest)
    all_phase3_message = "All PRs are now in phase3 (ready for review)"  # Message when all PRs are in phase3
    
    # Phase3 auto-merge settings (optional)
    # Automatically merges PRs when they reach phase3 (awaiting review).
    # Before merging, the comment defined below will be posted to the PR.
    # After a successful merge, the feature branch is automatically deleted.
    # IMPORTANT: For safety, this feature is disabled by default.
    # You must explicitly enable it by setting enable_execution_phase3_to_merge = true in the rulesets for each repository.
    # IMPORTANT: If auto-merge is enabled, the comment field must be explicitly set.
    [phase3_merge]
    comment = "The agent determines that review comments have been addressed. User review is skipped under user responsibility. Merging PR."  # Comment to post before merging (required when auto-merge is enabled)
    automated = false  # Set to true to click the merge button via browser automation
    wait_seconds = 10  # Wait time (seconds) after browser launch, before button click
    debug_dir = "debug_screenshots"  # Destination for debug information upon image recognition failure (default: "debug_screenshots")
    
    # Auto-assign issues to Copilot (completely optional! This entire section is optional)
    #
    # Simple usage: Just set assign_good_first_old = true in rulesets (see example above).
    # Define this section ONLY if you want to customize the default behavior.
    #
    # Assignment behavior is controlled by ruleset flags:
    # - assign_good_first_old: Assigns the oldest "good first issue" (by issue number, default: false)
    # - assign_old: Assigns the oldest issue (by issue number, label agnostic, default: false)
    # If both are true, "good first issue" takes precedence.
    #
    # Default behavior (if this section is not defined):
    # - Automatically clicks buttons via browser automation
    # - Uses PyAutoGUI for image recognition
    # - OCR fallback (optional) if image recognition fails
    # - wait_seconds = 10
    #
    # Required: PyAutoGUI installation needed (pip install pyautogui pillow)
    # Optional: pytesseract installation needed for OCR fallback
    #
    # IMPORTANT: For safety, this feature is disabled by default.
    # You must explicitly enable it by setting assign_good_first_old or assign_old in the rulesets for each repository.
    [assign_to_copilot]
    wait_seconds = 10  # Wait time (seconds) after browser launch, before button click
    debug_dir = "debug_screenshots"  # Destination for debug information upon image recognition failure (default: "debug_screenshots")
    confidence = 0.8  # Image matching confidence 0.0-1.0 (default: 0.8)
    enable_ocr_detection = true  # Enable OCR fallback (default: true)
    # enable_html_detection = false  # HTML detection fallback (experimental, default: false)
    ```

4.  **Preparing Button Screenshots (only if using automation)**:
    
    If using automation features (i.e., `automated = true` or `assign_to_copilot` / `phase3_merge` enabled),
    PyAutoGUI requires screenshots of the buttons it needs to click.
    
    **Required Screenshots:**
    
    For automatic issue assignment (`assign_to_copilot` feature):
    - `assign_to_copilot.png` - Screenshot of the "Assign to Copilot" button
    - `assign.png` - Screenshot of the "Assign" button
    
    For automatic PR merging (`phase3_merge` feature when `automated = true`):
    - `merge_pull_request.png` - Screenshot of the "Merge pull request" button
    - `confirm_merge.png` - Screenshot of the "Confirm merge" button
    - `delete_branch.png` - Screenshot of the "Delete branch" button (optional)
    
    **How to Take Screenshots:**
    
    a. Open a GitHub issue or PR in your browser.
    b. Find the button you want to automate.
    c. Take a screenshot of **only the button** (not the entire screen).
    d. Save it in PNG format to the `screenshots` directory.
    e. Use the exact filenames listed above.
    
    **Tips:**
    - The screenshot should include only the button, with a small margin.
    - Use your OS's screenshot tool (Windows: Snipping Tool, Mac: Cmd+Shift+4).
    - Ensure the button is clearly visible and not obscured.
    - If the button's appearance changes (e.g., due to theme changes), you'll need to update the screenshots.
    - Use the `confidence` setting to adjust image recognition reliability (due to DPI scaling or theme changes).
    
    **Automatic Saving of Debug Information:**
    - If image recognition fails, debug information is automatically saved.
    - Saved to: `debug_screenshots/` directory (default).
    - Saved content:
      - Screenshot (full screen at the time of failure): `{button_name}_fail_{timestamp}.png`
      - Screenshot of candidate regions (if found): `{button_name}_candidate_{timestamp}_{number}.png`
      - Failure information JSON: `{button_name}_fail_{timestamp}.json`
        - Button name, timestamp, confidence threshold, screenshot path, template image path.
        - Candidate region information (coordinates, size, confidence).
    - For debugging, detects up to 3 candidate regions with lower confidence (0.7, 0.6, 0.5).
    - The debug directory can be changed with the `debug_dir` option (within `assign_to_copilot` or `phase3_merge` sections).
    
    **Fallback Methods (if image recognition fails):**
    - **OCR Detection (enabled by default)**: Detects button text using pytesseract.
      - Directly detects text like "Assign to Copilot" from the screen.
      - Robust against subpixel rendering differences.
      - Required: tesseract-ocr installation (system-level).
      - Disable: `enable_ocr_detection = false`.
    
    **Important Requirements:**
    - You must **already be logged into GitHub** in your default browser.
    - Automation uses an existing browser session (does not perform new authentication).
    - Ensure the correct GitHub window/tab is focused and visible on screen when buttons are clicked.
    - If multiple GitHub pages are open, the first found button will be clicked.
    
    **Create the screenshots directory:**
    ```bash
    mkdir screenshots
    ```

5.  Install PyAutoGUI (only if using automation):
    
    For basic image recognition only:
    ```bash
    pip install pyautogui pillow pygetwindow
    ```
    
    Including OCR fallback (recommended):
    ```bash
    pip install -r requirements-automation.txt
    ```
    
    If using OCR, install tesseract-ocr on your system:
    -   **Windows**: `choco install tesseract`
    -   **macOS**: `brew install tesseract`
    -   **Linux**: `apt-get install tesseract-ocr`

### Execution

Start the tool to begin monitoring:

```bash
python3 cat-github-watcher.py [config.toml]
```

Or, run directly as a Python module:

```bash
python3 -m src.gh_pr_phase_monitor.main [config.toml]
```

### Workflow

1.  **Startup**: When the tool starts, it begins monitoring user-owned repositories for the authenticated GitHub user.
2.  **PR Detection**: Automatically detects repositories with open PRs.
3.  **Phase Determination**: Determines the phase of each PR (phase1/2/3, LLM working).
4.  **Action Execution**:
    -   **phase1**: Dry-run by default (changes Draft PR to Ready state if `enable_execution_phase1_to_phase2 = true` in rulesets).
    -   **phase2**: Dry-run by default (posts a comment requesting Copilot to apply changes if `enable_execution_phase2_to_phase3 = true` in rulesets).
    -   **phase3**: Opens the PR page in the browser.
        -   Sends ntfy.sh notification if `enable_execution_phase3_send_ntfy = true` in rulesets.
        -   Automatically merges the PR if `enable_execution_phase3_to_merge = true` in rulesets (uses global `[phase3_merge]` settings).
    -   **LLM working**: Waits (if all PRs are in this state, displays top N issues from repositories with no open PRs).
5.  **Issue Auto-Assignment**: If all PRs are "LLM working" and there are repositories with no open PRs:
    -   Assigns the oldest "good first issue" automatically if `assign_good_first_old = true` in rulesets (by issue number).
    -   Assigns the oldest issue automatically if `assign_old = true` in rulesets (by issue number, label agnostic).
    -   If both are true, "good first issue" takes precedence.
    -   Default behavior: Automatically clicks buttons via PyAutoGUI (no `[assign_to_copilot]` section needed).
    -   Required: PyAutoGUI installation and button screenshots must be prepared.
6.  **Repeat**: Continues monitoring at the configured interval.
    -   If no state changes are detected for the duration set by `no_change_timeout`, it automatically switches to power-saving mode (`reduced_frequency_interval`) to reduce API usage.
    -   It reverts to the normal monitoring interval when changes are detected.

### Dry-run Mode

By default, the tool operates in **Dry-run Mode** and does not execute actual actions. This allows you to safely verify its operation.

-   **Phase1 (Draft ‚Üí Ready)**: Displays `[DRY-RUN] Would mark PR as ready for review` but does nothing.
-   **Phase2 (Comment Posting)**: Displays `[DRY-RUN] Would post comment for phase2` but does nothing.
-   **Phase3 (ntfy Notification)**: Displays `[DRY-RUN] Would send ntfy notification` but does nothing.
-   **Phase3 (Merge)**: Displays `[DRY-RUN] Would merge PR` but does nothing.

To enable actual actions, set the following flags to `true` in the `[[rulesets]]` section of `config.toml`:
```toml
[[rulesets]]
name = "Enable automation for specific repository"
repositories = ["test-repo"]  # Or ["all"] for all repositories
enable_execution_phase1_to_phase2 = true  # Marks Draft PRs as Ready
enable_execution_phase2_to_phase3 = true  # Posts Phase2 comments
enable_execution_phase3_send_ntfy = true  # Sends ntfy notifications
enable_execution_phase3_to_merge = true   # Merges Phase3 PRs
assign_good_first_old = true              # Auto-assigns good first issues
```

### Stopping

You can stop monitoring by pressing `Ctrl+C`.

## Notes

-   GitHub CLI (`gh`) must be installed and authenticated.
-   It assumes integration with GitHub Copilot (specifically `copilot-pull-request-reviewer` and `copilot-swe-agent`).
-   **Only user-owned repositories** of the authenticated user are monitored. To keep the tool simple and focused, Organization repositories are not included (YAGNI principle).
-   Be mindful of GitHub API rate limits when using the GraphQL API.
-   If using ntfy.sh notifications, configure a topic on [ntfy.sh](https://ntfy.sh/) beforehand.

## Testing

The project includes a test suite using pytest:

```bash
pytest tests/
```

## License

MIT License - See the LICENSE file for details.

Note: The English README.md is automatically generated from README.ja.md by GitHub Actions using Gemini's translation.

*Big Brother is watching your repositories. Now it‚Äôs the cat.* üê±