# cat-github-watcher

**PR monitoring tool for the GitHub Copilot automated implementation phase**

<p align="left">
  <a href="README.ja.md"><img src="https://img.shields.io/badge/üáØüáµ-Japanese-red.svg" alt="Japanese"></a>
  <a href="README.md"><img src="https://img.shields.io/badge/üá∫üá∏-English-blue.svg" alt="English"></a>
  <a href="https://deepwiki.com/cat2151/cat-github-watcher"><img src="https://deepwiki.com/badge.svg" alt="Ask DeepWiki"></a>
</p>

*Note: This document is largely AI-generated. It was generated by feeding an issue to an agent.*

## Status
- Currently dogfooding.
- Major bugs have been largely addressed.
- Breaking changes occur frequently.
- Memo
  - Initially, an implementation with GitHub Actions was attempted, but it proved unsuitable for the purpose of PR monitoring, so we transitioned to a Python version.
  - The Python version monitors user-owned repositories of an authenticated GitHub user and performs notifications and actions according to the PR's phase.

## Quick Links
| Item | Link |
|------|--------|
| üìä GitHub Repository | [cat2151/cat-github-watcher](https://github.com/cat2151/cat-github-watcher) |

## Overview

This is a Python tool that monitors the phases of PRs where GitHub Copilot performs automated implementations, executing notifications and actions at appropriate times.
It efficiently monitors PRs using the GraphQL API, targeting user-owned repositories of an authenticated GitHub user.

## Features

- **Automatic Monitoring of All Repositories**: Automatically monitors PRs in user-owned repositories of an authenticated GitHub user.
- **Leveraging GraphQL API**: Achieves high-speed monitoring through efficient data retrieval.
- **Phase Detection**: Automatically determines PR status (phase1: Draft state, phase2: Addressing review comments, phase3: Waiting for review, LLM working: Coding agent in progress).
- **Dry-run Mode**: By default, it only monitors and does not perform actual actions (comment posting, marking PR as ready, sending notifications). It can be safely operated by explicitly enabling actions.
- **Automatic Comment Posting**: Automatically posts appropriate comments according to the phase (requires activation in the configuration file).
- **Automatic Readying of Draft PRs**: Automatically changes Draft PRs to a Ready state for addressing review comments in phase2 (requires activation in the configuration file).
- **Mobile Notifications**: Notifies mobile devices via ntfy.sh when phase3 (waiting for review) is detected (requires activation in the configuration file).
  - Notifies when an individual PR enters phase3.
  - Also notifies when all PRs enter phase3 (message configurable in TOML).
- **Issue List Display**: If all PRs are "LLM working", displays the top N issues (default: 10, configurable via `issue_display_limit`) for repositories with no open PRs.
- **Power Saving Mode**: If there are no status changes, the monitoring interval is automatically extended to reduce API usage (configurable via `no_change_timeout` and `reduced_frequency_interval`).
- **Verbose Mode**: Displays detailed configuration information at startup and during execution to assist in detecting configuration errors (enabled via `verbose`).

## Architecture

This tool is a Python application modularized according to the Single Responsibility Principle (SRP).

### Directory Structure

```
cat-github-watcher/
‚îú‚îÄ‚îÄ cat-github-watcher.py    # Entry point
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îî‚îÄ‚îÄ gh_pr_phase_monitor/
‚îÇ       ‚îú‚îÄ‚îÄ colors.py         # ANSI color codes and coloring
‚îÇ       ‚îú‚îÄ‚îÄ config.py         # Configuration loading and parsing
‚îÇ       ‚îú‚îÄ‚îÄ github_client.py  # GitHub API integration
‚îÇ       ‚îú‚îÄ‚îÄ phase_detector.py # PR phase detection logic
‚îÇ       ‚îú‚îÄ‚îÄ comment_manager.py # Comment posting and verification
‚îÇ       ‚îú‚îÄ‚îÄ pr_actions.py     # PR actions (Readying, browser launch)
‚îÇ       ‚îî‚îÄ‚îÄ main.py           # Main execution loop
‚îî‚îÄ‚îÄ tests/                    # Test files
```

### Phase Detection Logic

The tool identifies the following four phases:

1. **phase1 (Draft state)**: When the PR is in a Draft state and there is a review request.
2. **phase2 (Addressing review comments)**: When copilot-pull-request-reviewer has posted review comments and corrections are needed.
3. **phase3 (Waiting for review)**: When copilot-swe-agent has completed corrections and is waiting for human review.
4. **LLM working (Coding agent in progress)**: When none of the above apply (e.g., Copilot is implementing).

## Usage

### Prerequisites

- Python 3.x is installed.
- GitHub CLI (`gh`) is installed and authenticated.
  ```bash
  gh auth login
  ```

### Setup

1. Clone this repository:
   ```bash
   git clone https://github.com/cat2151/cat-github-watcher.git
   cd cat-github-watcher
   ```

2. Create a configuration file (optional):
   ```bash
   cp config.toml.example config.toml
   ```

3. Edit `config.toml` to configure monitoring intervals, execution modes, ntfy.sh notifications, Copilot auto-assignment, and auto-merge (optional):
   ```toml
   # Check interval (e.g., "30s", "1m", "5m", "1h", "1d")
   interval = "1m"
   
   # Maximum number of issues to display from repositories without open PRs
   # Default is 10, but can be changed to any positive number (e.g., 5, 15, 20)
   issue_display_limit = 10
   
   # Timeout duration for no status change
   # If the status of all PRs (phase of each PR) does not change for this duration,
   # the monitoring interval will switch to power-saving mode (reduced_frequency_interval below).
   # Setting an empty string "" will disable this feature.
   # Supported formats: "30s", "1m", "5m", "30m", "1h", "1d"
   # Default: "30m" (30 minutes - stability priority)
   no_change_timeout = "30m"
   
   # Override the mention for the coding agent used in posted comments (defaults to @copilot)
   [coding_agent]
   agent_name = "@codex[agent]"
   
   # Monitoring interval during power-saving mode
   # If no status changes are detected during the no_change_timeout period,
   # the monitoring interval will switch to this interval to reduce API usage.
   # When a change is detected, it reverts to the normal monitoring interval.
   # Supported formats: "30s", "1m", "5m", "30m", "1h", "1d"
   # Default: "1h" (1 hour)
   reduced_frequency_interval = "1h"
   
   # Verbose Mode - Displays detailed configuration information
   # When enabled, displays all settings at startup and repository-specific settings during execution.
   # Helps in detecting configuration errors.
   # Default: false
   verbose = false
   
   # Execution control flags - can only be specified within the [[rulesets]] section
   # Global flags are no longer supported.
   # To apply settings to all repositories, use 'repositories = ["all"]'.
   
   # Ruleset configuration example:
   # [[rulesets]]
   # name = "Default for all repositories - dry-run mode"
   # repositories = ["all"]  # "all" matches all repositories
   # enable_execution_phase1_to_phase2 = false  # Set to true to mark draft PRs as ready
   # enable_execution_phase2_to_phase3 = false  # Set to true to post phase2 comments
   # enable_execution_phase3_send_ntfy = false  # Set to true to send ntfy notifications
   # enable_execution_phase3_to_merge = false   # Set to true to merge phase3 PRs
   
   # [[rulesets]]
   # name = "Simple: Auto-assign 'good first issue' to Copilot"
   # repositories = ["my-repo"]
   # assign_good_first_old = true  # This is enough! The [assign_to_copilot] section is not needed.
   #                               # Default behavior: Open issue in browser for manual assignment.
   
   # ntfy.sh notification settings (optional)
   # Notifications include a clickable action button to open the PR.
   [ntfy]
   enabled = false  # Set to true to enable notifications
   topic = "<Enter your ntfy.sh topic name here>"  # Anyone can read and write to it, so use a string that is not easily guessable.
   message = "PR is ready for review: {url}"  # Message template
   priority = 4  # Notification priority (1=lowest, 3=default, 4=high, 5=highest)
   all_phase3_message = "All PRs are now in phase3 (ready for review)"  # Message when all PRs enter phase3
   
   # Phase3 Auto-merge settings (optional)
   # Automatically merges the PR when it reaches phase3 (waiting for review).
   # Before merging, the comment defined below will be posted to the PR.
   # After successful merge, the feature branch will be automatically deleted.
   # IMPORTANT: For safety, this feature is disabled by default.
   # You must explicitly enable it by specifying enable_execution_phase3_to_merge = true in rulesets for each repository.
   # IMPORTANT: If auto-merge is enabled, the 'comment' field must be explicitly set.
   [phase3_merge]
   comment = "The agent has determined that review comments have been addressed. User review will be skipped under user's responsibility. Merging PR."  # Comment to post before merging (required when auto-merge is enabled)
   automated = false  # Set to true to click the merge button via browser automation.
   wait_seconds = 10  # Wait time in seconds after browser launch before clicking the button.
   debug_dir = "debug_screenshots"  # Destination for debug information on image recognition failure (default: "debug_screenshots").
   
   # Auto-assign issues to Copilot (completely optional! This entire section is optional.)
   # 
   # Simple usage: Just set assign_good_first_old = true in rulesets (see example above).
   # Define this section only if you want to customize the default behavior.
   # 
   # Assignment behavior is controlled by ruleset flags:
   # - assign_good_first_old: Assigns the oldest "good first issue" (by issue number, default: false).
   # - assign_old: Assigns the oldest issue (by issue number, label-agnostic, default: false).
   # If both are true, "good first issue" takes precedence.
   # 
   # Default behavior (if this section is not defined):
   # - Automatically clicks buttons via browser automation.
   # - Image recognition using PyAutoGUI.
   # - OCR fallback if image recognition fails (optional).
   # - wait_seconds = 10
   # 
   # Required: PyAutoGUI installation is needed (pip install pyautogui pillow).
   # Optional: pytesseract installation is needed for OCR fallback.
   # 
   # IMPORTANT: For safety, this feature is disabled by default.
   # You must explicitly enable it by specifying assign_good_first_old or assign_old in rulesets for each repository.
   [assign_to_copilot]
   wait_seconds = 10  # Wait time in seconds after browser launch before clicking the button.
   debug_dir = "debug_screenshots"  # Destination for debug information on image recognition failure (default: "debug_screenshots").
   confidence = 0.8  # Image matching confidence 0.0-1.0 (default: 0.8).
   enable_ocr_detection = true  # Enable OCR fallback (default: true).
   # enable_html_detection = false  # HTML detection fallback (experimental, default: false).
   ```

4. **Prepare Button Screenshots (for automation only)**:
   
   If you use automation features (`automated = true` or enabling `assign_to_copilot` / `phase3_merge`),
   screenshots of the buttons PyAutoGUI needs to click are required.
   
   **Required Screenshots:**
   
   For automatic issue assignment (`assign_to_copilot` feature):
   - `assign_to_copilot.png` - Screenshot of the "Assign to Copilot" button
   - `assign.png` - Screenshot of the "Assign" button
   
   For automatic PR merge (when `automated = true` in `phase3_merge` feature):
   - `merge_pull_request.png` - Screenshot of the "Merge pull request" button
   - `confirm_merge.png` - Screenshot of the "Confirm merge" button
   - `delete_branch.png` - Screenshot of the "Delete branch" button (optional)
   
   **How to Take Screenshots:**
   
   a. Open a GitHub issue or PR in your browser.
   b. Find the button you want to automate.
   c. Take a screenshot of **only the button** (not the entire screen).
   d. Save it in PNG format to the `screenshots` directory.
   e. Use the exact filenames listed above.
   
   **Tips:**
   - The screenshot should include only the button, with a small margin.
   - Use your OS's screenshot tool (Windows: Snipping Tool, Mac: Cmd+Shift+4).
   - Ensure the button is clearly visible and not obscured.
   - If the button's appearance changes (e.g., due to theme changes), you'll need to update the screenshots.
   - Use the `confidence` setting to adjust image recognition reliability (due to DPI scaling or themes).
   
   **Automatic Saving of Debug Information:**
   - If image recognition fails, debug information is automatically saved.
   - Destination: `debug_screenshots/` directory (default).
   - Contents saved:
     - Screenshot (entire screen at time of failure): `{button_name}_fail_{timestamp}.png`
     - Screenshot of candidate regions (if found): `{button_name}_candidate_{timestamp}_{number}.png`
     - Failure information JSON: `{button_name}_fail_{timestamp}.json`
       - Button name, timestamp, confidence threshold, screenshot path, template image path.
       - Information on candidate regions (coordinates, size, confidence).
   - During debugging, up to 3 candidate regions are detected with lower confidence (0.7, 0.6, 0.5).
   - The debug directory can be changed in settings: `debug_dir` option (within the `assign_to_copilot` or `phase3_merge` sections).
   
   **Fallback Methods (if image recognition fails):**
   - **OCR Detection (enabled by default)**: Uses pytesseract to detect button text.
     - Directly detects text like "Assign to Copilot" from the screen.
     - Robust against sub-pixel rendering differences.
     - Required: tesseract-ocr installation (system level).
     - Disable: `enable_ocr_detection = false`
   
   **Important Requirements:**
   - You must already be **logged in to GitHub** in your default browser.
   - Automation uses existing browser sessions (no new authentication is performed).
   - Ensure the correct GitHub window/tab is focused and visible on screen when a button is to be clicked.
   - If multiple GitHub pages are open, the first found button will be clicked.
   
   **Create Screenshots Directory:**
   ```bash
   mkdir screenshots
   ```

5. Install PyAutoGUI (for automation only):
   
   For basic image recognition only:
   ```bash
   pip install pyautogui pillow pygetwindow
   ```
   
   Including OCR fallback (recommended):
   ```bash
   pip install -r requirements-automation.txt
   ```
   
   If using OCR, install tesseract-ocr on your system:
   - **Windows**: `choco install tesseract`
   - **macOS**: `brew install tesseract`
   - **Linux**: `apt-get install tesseract-ocr`

### Execution

Start the tool to begin monitoring:

```bash
python3 cat-github-watcher.py [config.toml]
```

Or, run directly as a Python module:

```bash
python3 -m src.gh_pr_phase_monitor.main [config.toml]
```

### Workflow

1. **Startup**: When the tool starts, it begins monitoring user-owned repositories of the authenticated GitHub user.
2. **PR Detection**: Automatically detects repositories with open PRs.
3. **Phase Determination**: Determines the phase of each PR (phase1/2/3, LLM working).
4. **Action Execution**:
   - **phase1**: Default is Dry-run (setting `enable_execution_phase1_to_phase2 = true` in rulesets changes Draft PRs to Ready state).
   - **phase2**: Default is Dry-run (setting `enable_execution_phase2_to_phase3 = true` in rulesets posts a comment requesting Copilot to apply changes).
   - **phase3**: Opens the PR page in the browser.
     - If `enable_execution_phase3_send_ntfy = true` is set in rulesets, also sends ntfy.sh notification.
     - If `enable_execution_phase3_to_merge = true` is set in rulesets, automatically merges the PR (using global `[phase3_merge]` settings).
   - **LLM working**: Waits (if all PRs are in this state, displays issues from repositories with no open PRs).
5. **Automatic Issue Assignment**: If all PRs are "LLM working" and there are repositories with no open PRs:
   - If `assign_good_first_old = true` is set in rulesets, automatically assigns the oldest "good first issue" (by issue number).
   - If `assign_old = true` is set in rulesets, automatically assigns the oldest issue (by issue number, label-agnostic).
   - If both are true, "good first issue" takes precedence.
   - Default behavior: PyAutoGUI automatically clicks buttons (the `[assign_to_copilot]` section is not required).
   - Required: PyAutoGUI installation and button screenshots preparation are needed.
6. **Repeat**: Continues monitoring at the configured interval.
   - If no status changes occur for the duration set by `no_change_timeout`, it automatically switches to power-saving mode (`reduced_frequency_interval`) to reduce API usage.
   - When a change is detected, it reverts to the normal monitoring interval.

### Dry-run Mode

By default, the tool operates in **Dry-run mode** and does not perform actual actions. This allows you to safely verify its operation.

- **Phase1 (Draft ‚Üí Ready)**: Displays `[DRY-RUN] Would mark PR as ready for review` but does not perform any action.
- **Phase2 (Comment Posting)**: Displays `[DRY-RUN] Would post comment for phase2` but does not perform any action.
- **Phase3 (ntfy Notification)**: Displays `[DRY-RUN] Would send ntfy notification` but does not perform any action.
- **Phase3 (Merge)**: Displays `[DRY-RUN] Would merge PR` but does not perform any action.

To enable actual actions, set the following flags to `true` in the `[[rulesets]]` section of `config.toml`:
```toml
[[rulesets]]
name = "Enable automation for specific repositories"
repositories = ["test-repo"]  # Or ["all"] for all repositories
enable_execution_phase1_to_phase2 = true  # Mark Draft PRs as Ready
enable_execution_phase2_to_phase3 = true  # Post Phase2 comments
enable_execution_phase3_send_ntfy = true  # Send ntfy notifications
enable_execution_phase3_to_merge = true   # Merge Phase3 PRs
assign_good_first_old = true              # Auto-assign good first issues
```

### Stopping

You can stop monitoring with `Ctrl+C`.

## Important Considerations

- GitHub CLI (`gh`) must be installed and authenticated.
- It assumes integration with GitHub Copilot (specifically copilot-pull-request-reviewer and copilot-swe-agent).
- Only **user-owned repositories** of the authenticated user are monitored. Organization repositories are not included to keep the tool simple and focused (YAGNI principle).
- Be aware of API rate limits as it uses the GraphQL API.
- If using ntfy.sh notifications, configure a topic on [ntfy.sh](https://ntfy.sh/) beforehand.

## Testing

The project includes a test suite using pytest:

```bash
pytest tests/
```

## License

MIT License - See the LICENSE file for details.

*The English README.md is automatically generated by GitHub Actions using Gemini's translation based on README.ja.md.*

*Big Brother is watching your repositories. Now it‚Äôs the cat.* üê±